# SECURITY OPS

本書はDNSweeperの運用における安全設計と「地雷回避」のための実装/運用ガイドです。

## 原則
- 最小権限・最小情報: CI/実行に必要な権限・秘密のみ付与。
- 明示的なレート/タイムアウト: HTTP/DoHはQPS・タイムアウト・リダイレクト上限を必ず設定。
- 監査可能性: コマンド/バージョン/成果物の証跡を残す（artifacts/ 配下）。
- 二段階承認: 破壊的操作（apply等）はレビュー＋承認を必須化。

## 地雷早見表（実装）
- 正規表現: ユーザ入力をそのまま `new RegExp()` に使わない（ReDoS回避）。固定パターン or 安全な前処理（長さ/文字クラス制限）。
- 外部コマンド: 原則禁止。必要時はホワイトリスト・絶対パスで呼び出し、引数はエスケープ（シェル展開不可）。
- ファイル出力: `path.resolve` で安全なベースディレクトリ配下に限定し、親ディレクトリ遡り（..）を拒否。
- JSONLログ: 改行/制御文字エスケープ、1行上限（例: 32KB）とローテーションを実施。
- HTTPプローブ: リダイレクト回数上限（例:5）、本文ダウンロード抑止（HEAD→必要時GET）、ヘッダ/本文サイズ上限、タイムアウト厳守。
- DoHキャッシュ: キー正規化（`<name>|<type>`）、TTL尊重、壊れたエントリの隔離/無効化。
- スナップショット/計画: 入力ハッシュ付与、ルールセット版数を記録、人手レビュー前提で利用。
- 例外/ログ: スタック/機密はstderr/ファイルに露出しない（要マスキング）。

## 運用ガード
- QPSと並列数のプリセット: `dnsweeper.config.json` に安全既定値（例: qps=100, concurrency=40, timeoutMs=3000）。
- private/special先のプローブ既定スキップ（現実装済）。解除は明示フラグのみ。
- ジョブスナップショット: 入力+ルールセット一致時のみ再開、差異時は強警告。
- 監査ログ: HOME不可時は `.tmp/audit.log` にフォールバックし、後続で集約。

## sweep apply の扱い
- GAまで封印し、`plan` 生成のみに限定。
- 実適用が必要な場合でも、別ツール/別権限で二段階承認フローを要求（レビュー→実行）。

